<?php include '/app/public/views/partials/header.php'; ?>
<link rel="stylesheet" type="text/css" href="public/styles/profile.css">
<link rel="stylesheet" type="text/css" href="public/styles/calendar.css">
<link rel="stylesheet" type="text/css" href="public/styles/pets.css">
<link rel="stylesheet" type="text/css" href="public/styles/welcome.css">
<link rel="stylesheet" type="text/css" href="public/styles/editPet.css">
<link rel="stylesheet" type="text/css" href="public/styles/modal.css">

    <title>Calendar</title>
</head>

<body>
    <div class="wrapper">
        
        <div class="top-bar top-bar-clear">
            <a href="/welcome" class="back-arrow">&lt;</a> 
            <h1>Calendar</h1>

            <div class="profile-pic-container profile">
                <a href="/profile">
                    <div class="profile-pic"> 
                        <img src="<?= $user['picture_url'] ? $user['picture_url'] : 'public/img/profile.png' ?>" 
                        alt="Profile Picture" 
                        class="profile-icon-main <?= $user['picture_url'] ? 'user-photo' : '' ?>">
                    </div>
                </a>
            </div>
        </div>

        <div class="card-container-welcome">

            <div class="card-welcome calendar-container">
                
                <div class="tab-switch">
                    <button class="tab-button active" id="calendar-tab">Calendar</button>
                    <button class="tab-button" id="list-tab">List</button>
                </div>

                <div class="calendar-view" id="calendar-view">
                    <div class="calendar-header-view">
                        <span class="nav-arrow-preview" id="prev-month">&lt;</span>
                        <span id="current-month-year"><?= date('F Y') ?></span>
                        <span class="nav-arrow-preview" id="next-month">&gt;</span>
                    </div>
                    
                    <div class="weekdays-preview">
                        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                    </div>
                    
                    <div class="days-grid-preview" id="days-grid"></div>
                </div>

                <div class="list-view-container" id="list-view-container">
                    <?php 
                        $hasUpcoming = false;
                        $today = date('Y-m-d');
                        
                        // Iterowanie po eventach pobranych z widoku
                        foreach ($events as $event) {
                            // Tylko nadchodzące wydarzenia (filtr)
                            if ($event['date'] >= $today) { 
                                $hasUpcoming = true;
                                ?>
                                <div class="event-card">
                                    <div class="event-image-container">
                                        <img src="<?= !empty($event['picture_url']) ? $event['picture_url'] : 'public/img/default_pet.png' ?>" class="event-image">
                                    </div>
                                    <div class="event-details">
                                        <div class="event-title"><?= htmlspecialchars($event['title']) ?></div>
                                        <div class="event-pet-name">
                                            <?= htmlspecialchars($event['pet_name']) ?> • <?= date('d.m.Y', strtotime($event['date'])) ?>
                                        </div>
                                    </div>
                                    <div class="event-time">
                                        <?= $event['time'] ? date('H:i', strtotime($event['time'])) : '' ?>
                                    </div>

                                    <img src="public/img/delete_calendar.png" 
                                     class="bin-icon"
                                     data-id="<?= $event['id'] ?>" 
                                     data-action="/deleteEvent"
                                     onclick="prepareDelete(this.dataset.id, this.dataset.action)">
                                </div>
                                <?php
                            }
                        }
                        if (!$hasUpcoming) {
                            echo '<p class="events">There are no upcoming events!</p>';
                        }
                    ?>
                </div>

            </div>

            <div class="card-welcome calendar-container">
                <div class="today-events-header">Today's Events (<?= date('d.m') ?>)</div>
                
                <?php 
                    $hasToday = false;
                    $todayDate = date('Y-m-d');
                    foreach ($events as $event): 
                        if ($event['date'] === $todayDate):
                            $hasToday = true;
                ?>
                    <div class="event-card">
                        <div class="event-image-container">
                            <img src="<?= !empty($event['picture_url']) ? $event['picture_url'] : 'public/img/default_pet.png' ?>" alt="<?= $event['pet_name'] ?>" class="event-image">
                        </div>
                        <div class="event-details">
                            <div class="event-title"><?= htmlspecialchars($event['title']) ?></div>
                            <div class="event-pet-name">
                                <?= htmlspecialchars($event['pet_name']) ?>
                            </div>
                        </div>
                        <div class="event-time">
                            <?= $event['time'] ? date('H:i', strtotime($event['time'])) : '' ?>
                        </div>
                    </div>
                <?php 
                        endif;
                    endforeach; 

                    if (!$hasToday):
                ?>
                    <div class="noevents">No events for today.</div>
                <?php endif; ?>
            </div>
        </div>

        <button type="button" 
                class="button add-button" 
                data-today="<?= date('Y-m-d') ?>"
                onclick="openModalWithDate('addModal', this.dataset.today)">+</button>

        <div id="addModal" class="modal-overlay">
            <div class="modal-content wrapper">
                <form method="POST" action="/addEvent">
                    <div class="modal-header-actions">
                        <button type="button" class="action-btn close-btn" onclick="closeModal('addModal')">
                            <img src="public/img/cancel.png" alt="Close">
                        </button>
                        <div class="right-actions">
                            <button type="submit" class="action-btn save-btn">
                                <img src="public/img/confirm.png" alt="Save">
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Pet</label>
                        <div class="row-layout">
                            <div class="unit-selector-container">
                                <select name="pet_id" class="unit-dropdown" required>
                                    <?php foreach ($pets as $p): ?>
                                        <option value="<?= $p['id'] ?>"><?= $p['name'] ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="input-group vaccination-name-group">
                        <label class="input-label">Event's name</label>
                        <div class="container">
                            <input type="text" name="name" placeholder="Vet visit" maxlength="255" required>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Date</label>
                        <div class="row-layout">
                            <div class="container date-input-container">
                                <input type="date" name="date" id="modalDateInput" value="<?= date('Y-m-d') ?>" required>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Time</label>
                        <div class="row-layout">
                            <div class="container dose-input-small time">
                                <input type="time" name="time" value="">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="deleteModal" class="modal-overlay">
            <div class="modal-box">
                <h3>Are you sure?</h3>
                <p>Do you really want to delete this event?</p>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closeModal('deleteModal')">Cancel</button>
                    <form id="deleteForm" method="POST">
                        <input type="hidden" name="id" id="modalItemId" value="">
                        <button type="submit" class="btn-delete">Delete</button>
                    </form>
                </div>
            </div>
        </div>

    </div>
    
    <script id="calendar-data" type="application/json">
        <?= json_encode($events) ?>
    </script>
    <script src="public/scripts/calendar.js" defer></script>
    <script src="public/scripts/calendar-view-switcher.js" defer></script>
    <script src="public/scripts/deleteAddWindow.js" defer></script>
    <script src="public/scripts/deleteNutrition.js" defer></script>

</body>
</html>